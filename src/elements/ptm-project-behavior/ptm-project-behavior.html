<link rel="import" href="../../bower_components/iron-behaviors/iron-control-state.html">
<link rel="import" href="../../bower_components/iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">

<script>
var PtmProjectBehaviorImpl = {
  properties: {
    project: {
      type: Object,
      value: {}
    },
    fields: {
      type: Array,
      value: []
    },
    projectId: {
      type: String,
      value: '',
      reflectToAttribute: true
    },
    projectTitle: {
      type: String,
      value: '',
      reflectToAttribute: true
    },
    expanded: {
      type: Boolean,
      value: false,
      reflectToAttribute: true,
      observer: '_expandedChanged'
    },
    query: {
      type: String,
      value: ''
    },
    _unfoldIcon: {
      type: String,
      value: 'unfold-more'
    },
    _elevation: {
      type: Number,
      value: 0
    }
  },
  hostAttributes: {
    tabindex: 0
  },
  observers: [
    '_focusedChanged(receivedFocusFromKeyboard)'
  ],
  ready: function() {
    this.keyEventTarget = this;
    this.addOwnKeyBinding('left right', '_onArrow');
    this.addOwnKeyBinding('enter', 'openProject');
  },
  toggle: function(e) {
    e.stopPropagation();
    this.expanded = !this.expanded;
  },
  filter: function(item) {
    if (this.query.length < 2) {
      return true
    } else {
      return item.title.toLowerCase().indexOf(this.query.toLowerCase()) > -1;
    }
  },
  openProject: function(e) {
    e.stopPropagation();
    this.fire('open-clicked', {
      projectId: this.projectId
    });
  },
  _onArrow: function(e) {
    e.stopPropagation();
    switch (e.detail.key) {
      case 'left':
        this.expanded = false;
        break;
      case 'right':
        this.expanded = true;
        break;
    }
  },
  _expandedChanged: function() {
    this._unfoldIcon = this.expanded ? 'unfold-less' : 'unfold-more';
    this._elevation = this.expanded ? 2 : 0;
  },
  _focusedChanged: function(receivedFocusFromKeyboard) {
    this.focused != this.focused;
  },
  _computeElevation: function(expanded) {
    return expanded ? 2 : 0;
  },
  _computeFoldIcon: function(expanded) {
    return expanded ? 'unfold-less' : 'unfold-more';
  },
  _computeProjectLinked: function(projectId) {
    return projectId * 1 > -1 ? true : false;
  },
  _computeActive: function(winId) {
    return winId !== null;
  },
  _onToggleBookmark: function(e) {
    var that = this;
    e.stopPropagation();
    var field = e.model.item;
    var index = e.model.index;
    if (field.id === undefined || field.id === '') {
      this.project.addBookmark(field.tabId, function(bookmark) {
        that.set('fields.'+index+'.id', bookmark.id);
        that.fire('show-toast', {
          text: 'Bookmark added'
        });
      });
    } else {
      this.project.removeBookmark(field.id, function() {
        that.set('fields.'+index+'.id', '');
        that.fire('show-toast', {
          text: 'Bookmark removed'
        });
      });
    }
  },
  _onFieldUpdated: function() {
    console.log('field updated');
    this.$.repeat.render();
  }
};

var PtmProjectBehavior = [
  PtmProjectBehaviorImpl,
  Polymer.IronControlState,
  Polymer.IronA11yKeysBehavior
];
</script>