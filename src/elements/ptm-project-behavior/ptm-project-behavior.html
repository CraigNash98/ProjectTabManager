<script>
var PtmProjectBehavior = {
  properties: {
    project: {
      type: Object,
      value: {}
    },
    fields: {
      type: Array,
      value: []
    },
    sessionId: {
      type: String,
      value: '',
      reflectToAttribute: true
    },
    projectId: {
      type: String,
      value: '',
      reflectToAttribute: true
    },
    winId: {
      type: Number,
      value: undefined,
      reflectToAttribute: true
    },
    sessionTitle: {
      type: String,
      value: '',
      reflectToAttribute: true
    },
    projectTitle: {
      type: String,
      value: '',
      reflectToAttribute: true
    },
    expanded: {
      type: Boolean,
      value: false,
      reflectToAttribute: true
    },
    query: {
      type: String,
      value: '',
      observer: 'search'
    },
    matchedBookmarks: {
      type: Number,
      value: -1
    },
    _unfoldIcon: {
      type: String,
      value: 'unfold-more'
    },
    _elevation: {
      type: Number,
      value: 0
    }
  },
  hostAttributes: {
    tabindex: 0
  },
  toggle: function(e) {
    e.stopPropagation();
    this.expanded = !this.expanded;
    this._unfoldIcon = this.expanded ? 'unfold-less' : 'unfold-more';
    this._elevation = this.expanded ? 2 : 0;
  },
  search: function() {
    if (this.query.length < 2) {
      this.matchedBookmarks = 0;
    }
  },
  filter: function(item) {
    // TODO: This won't be executed unless project.title matches the query.
    // Needs to fix this
    if (this.query.length < 2) {
      return true
    } else {
      var matched = item.title.toLowerCase().indexOf(this.query.toLowerCase()) > -1;
      this.matchedBookmarks += matched ? 1 : 0;
      return matched;
    }
  },
  openProject: function(e) {
    e.stopPropagation();
    this.fire('open-project', {
      projectId: this.projectId
    });
  },
  _computeElevation: function(expanded) {
    return expanded ? 2 : 0;
  },
  _computeFoldIcon: function(expanded) {
    return expanded ? 'unfold-less' : 'unfold-more';
  },
  _computeProjectLinked: function(projectId) {
    return projectId * 1 > -1 ? true : false;
  },
  _onToggleBookmark: function(e) {
    var that = this;
    e.stopPropagation();
    var field = e.model.item;
    var index = e.model.index;
    if (field.id === undefined || field.id === '') {
      this.project.addBookmark(field.tabId, function(bookmark) {
        that.set('fields.'+index+'.id', bookmark.id);
        that.fire('show-toast', {
          text: 'Bookmark added'
        });
      });
    } else {
      this.project.removeBookmark(field.id, function() {
        that.set('fields.'+index+'.id', '');
        that.fire('show-toast', {
          text: 'Bookmark removed'
        });
      });
    }
  },
  _onFieldUpdated: function() {
    console.log('field updated');
    this.$.repeat.render();
  }
};
</script>