<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-meta/iron-meta.html">

<dom-module id="ptm-favicon">
  <style>
    :host {
      display: block;
      padding: 8px;
      width: 24px;
      height: 24px;
      -webkit-user-select: none;
      @apply (--paper-icon-button)
    }
    iron-icon {
      width: 100%;
      height: 100%;
    }
  </style>
  <template>
    <iron-meta id="meta" type="idb"></iron-meta>
    <iron-icon src="[[_validateFavIcon(favIconUrl)]]"></iron-icon>
  </template>
</dom-module>

<script>
  var DEFAULT_FAVICON_URL = '/img/favicon.png';
  var cache = {};
  Polymer({
    is: 'ptm-favicon',
    properties: {
      url: {
        type: String,
        value: '',
        reflectToAttribute: true
      },
      favIconUrl: {
        type: String,
        value: '',
        reflectToAttribute: true
      }
    },
    _validateFavIcon: function(src) {
      // Avoid blob url from older version
      if (!src || src.indexOf('blob') === 0) {
        return DEFAULT_FAVICON_URL;
      } else {
        return src;
      }
    },
    ready: function() {
      this.db = this.$.meta.byKey('ProjectTabManager-favicons');
      if (this.db.dbReady) {
        this.readFavicon();
      } else {
        this.db.addEventListener('idb-ready', this.readFavicon.bind(this));
      }
    },
    readFavicon: function() {
      var that = this;
      var domain = this._extractDomain(this.url);

      // If favicon is not specified
      if (!this.favIconUrl) {
        // But favicon url is already cached
        if (cache[domain]) {
          // Use the cache
          this.favIconUrl = cache[domain].url || '';
        // favicon url is not yet cached
        } else {
          // Look up on database
          this.db.get(domain).then(function(result) {
            // If there's an entry, use it and cache
            // Otherwise, fallback to default icon
            if (result) {
              that.favIconUrl = result.url || '';
              cache[domain] = {
                domain: domain,
                url: that.favIconUrl
              }
            }
          });
        }
      // If favicon is specified
      } else {
        // Check if cache exists
        if (!cache[domain]) {
          // Look up on database
          this.db.get(domain).then(function(result) {
            // If there's no entry or exists but differ
            if (!result || result.url != that.favIconUrl) {
              // Save the favicon
              that._saveFavIconUrl(domain, that.favIconUrl);
            }
            // Cache it regardless of database entry exists or not
            cache[domain] = {
              domain: domain,
              url: that.favIconUrl
            }
          })
        }
      }
    },
    _extractDomain: function(url) {
      var domain = url.replace(/^.*?:\/\/(.*?)\/.*$/, "$1");
      // Special case, if Google Docs, it could be /spreadsheet, /document or /presentation
      if (/docs.google.com/.test(domain)) {
        domain = url.replace(/^.*?:\/\/(.*?\/.*?)\/.*$/, "$1");
      }
      return domain;
    },
    _saveFavIconUrl: function(domain, favIconUrl) {
      this.db.put({
        domain: domain,
        url: favIconUrl
      });
    }
  });
</script>
