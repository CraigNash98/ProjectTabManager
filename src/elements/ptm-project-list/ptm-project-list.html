<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../ptm-list-behavior/ptm-list-behavior.html">
<link rel="import" href="../ptm-project/ptm-project.html">

<dom-module id="ptm-project-list">
  <style>
  </style>
  <template>
    <iron-meta id="meta" type="dialog"></iron-meta>
    <template id="repeat" is="dom-repeat" items="{{projectManager.projects}}" filter="filter">
      <ptm-project
        project="{{item}}"
        project-id="{{item.id}}"
        project-title="{{item.title}}"
        fields="{{item.fields}}"
        query="{{query}}"
        expanded="{{_isSearching(query)}}"
        on-open-clicked="open"
        on-rename-clicked="rename"
        on-remove-clicked="remove">
      </ptm-project>
    </template>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'ptm-project-list',
    behaviors: [
      PtmListBehavior
    ],
    filter: function(item) {
      if (this.query.length < 2) {
        return !!item.bookmark;
      } else {
        // If one of bookmarks / sessions matches, keep this project visible
        if (this._filterFields(item)) {
          return true;
        // Otherwise, keep this project only if title matches query
        } else {
          return item.title.toLowerCase().indexOf(this.query.toLowerCase()) > -1;
        }
      }
    },
    _isSearching: function(query) {
      return query == '' ? false : true;
    },
    rename: function(e) {
      var that = this;
      this.$.meta.byKey('confirm')
        .prompt({
          line1: 'Rename project',
          line2: 'Change project name. This will affect name of the project bookmark folder as well.',
          answer: e.model.item.title,
          placeholder: 'New project name',
          confirm: 'Update',
          cancel: 'Cancel'
        }).then(function(result) {
          that.projectManager.renameProject(e.model.item.id, result).then(function() {
            that.fire('reload');
            that.fire('show-toast', {
              text: 'Project renamed'
            });
          });
        });
    },
    remove: function(e) {
      var that = this;
      this.$.meta.byKey('confirm')
        .confirm({
          line1: 'Remove project?',
          line2: 'This will permanently remove project.',
          confirm: 'OK',
          cancel: 'Cancel'
        }).then(function() {
          that.projectManager.removeProject(e.model.item.id).then(function() {
            that.fire('reload');
            that.fire('show-toast', {
              text: 'Project removed'
            });
          });
        });
    }
  });
</script>
