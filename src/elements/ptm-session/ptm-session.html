<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../ptm-bookmark/ptm-bookmark.html">

<dom-module id="ptm-session">
  <style>
    :host {
      display: block;
    }
    paper-item {
      background-color: white;
      min-height: var(--ptm-entry-height, 24px);
    }
    paper-item > *:not(:first-child):not(:last-child) {
      margin-right: 0 !important;
    }
    paper-material {
      will-change: transition;
      -moz-transition: margin 0.3s linear;
      -webkit-transition: margin 0.3s linear;
      transition: margin 0.3s linear;
/*      min-height: 24px;
      height: var(--ptm-entry-height, 24px);
*/    }
    paper-material[expanded] {
      margin: 12px 0;
    }
    #title {
      font-size: var(--ptm-entry-font-size, 0.8em);
      cursor: pointer;
      color: #aaa;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }
    #title.bookmarked {
      color: black;
    }
  </style>
  <template>
    <paper-material elevation="{{_elevation}}" expanded$="{{expanded}}">
      <paper-item class="layout">
        <paper-icon-button icon="{{_unfoldIcon}}" on-click="toggle"></paper-icon-button>
        <span id="title" class="flex">{{title}}</span>
        <!-- <paper-ripple></paper-ripple> -->
        <template is="dom-if" if="{{expanded}}" restamp>
          <template is="dom-if" if="{{winId}}">
            <paper-icon-button icon="icons:link" on-click="clickLink"></paper-icon-button>
            <paper-icon-button icon="icons:create" on-click="clickEdit"></paper-icon-button>
            <paper-icon-button icon="icons:delete" on-click="clickRemove"></paper-icon-button>
          </template>
        </template>
      </paper-item>
      <iron-collapse id="collapse" opened="{{expanded}}" tabindex="-1">
        <template is="dom-if" if="{{!sessions.length}}">
          <paper-item class="layout">
            <paper-icon-button icon="icons:caution"></paper-icon-button>
            <span on-click="open" class="flex">No open tabs available</span>
          </paper-item>
        </template>
        <template id="bookmarkList" is="dom-repeat" items="{{sessions}}">
          <ptm-bookmark
            url="{{item.url}}"
            fav-icon-url="{{item.favIconUrl}}"
            tab-id="{{item.id}}"
            title="{{item.title}}"
            parentId="{{bookmarkId}}"
            on-toggle-bookmark="toggleBookmark"></ptm-bookmark>
        </template>
      </iron-collapse>
    </paper-material>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'ptm-session',
    properties: {
      sessions: {
        type: Array,
        value: []
      },
      sessionId: {
        type: String,
        value: '',
        reflectToAttribute: true
      },
      bookmarkId: {
        type: String,
        value: '',
        reflectToAttribute: true
      },
      winId: {
        type: Number,
        value: -1,
        reflectToAttribute: true
      },
      title: {
        type: String,
        value: '',
        reflectToAttribute: true
      },
      expanded: {
        type: Boolean,
        value: false,
        reflectToAttribute: true
      },
      _unfoldIcon: {
        type: String,
        value: 'unfold-more'
      },
      _elevation: {
        type: Number,
        value: 0
      }
    },
    toggle: function(e, detail, sender) {
      this.expanded = !this.expanded;
      this._unfoldIcon = this.expanded ? 'icons:unfold-less' : 'icons:unfold-more';
      this._elevation = this.expanded ? 5 : 0;
    },
    clickLink: function() {
      this.fire('ptm-session-link', {
        sessionId: this.sessionId,
        winId: this.winId
      });
    },
    clickCreate: function() {
      // TODO: implement rename function
      // this.fire('rename-session', {newTitle: this.session.title});
    },
    clickDelete: function() {
      this.fire('remove-session', {
        sessionId: this.sessionId,
        winId: this.winId
      });
    },
    toggleBookmark: function(e) {
      e.stopPropagation();
      console.log('toggle-bookmark', e);
      // if (e.detail.bookmarkId) {
      //   this.session.removeBookmark(e.detail.bookmarkId, function() {
      //     e.detail.bookmarkId = undefined;
      //   });
      // } else {
      //   this.session.addBookmark(e.detail.tabId, function(bookmark) {
      //     e.detail.animate = true;
      //     e.detail.session.bookmarkId = bookmark.id;
      //   });
      // }
    }
  });
</script>
