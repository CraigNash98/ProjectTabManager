<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../ptm-favicon/ptm-favicon.html">

<!--
entry {
  id         : bookmark id if bookmarked
  tabId      : tabId of the page if open
  title      : title of the page
  url        : url of the bookmark
  pinned     : pinned flag
  favIconUrl : favicon Url
}
-->
<dom-module id="ptm-bookmark">
  <style>
  paper-item {
    background-color: white;
    min-height: var(--ptm-entry-height, 24px);
  }
  paper-item > *:not(:first-child):not(:last-child) {
    margin-right: 0 !important;
  }
  #title {
    font-size: var(--ptm-entry-font-size, 0.8em);
    cursor: pointer;
    color: #aaa;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
  }
  #title.active {
    color: black;
  }
  #star {
    color: #D3D3D3;
  }
  #star.bookmarked {
    color: #FAC12F;
  }
  </style>
  <template>
    <paper-item class="layout">
      <ptm-favicon id="favicon" url="[[url]]" fav-icon-url="[[favIconUrl]]"></ptm-favicon>
      <span id="title" on-click="open" class="flex">{{title}}</span>
      <template is="dom-if" if="{{parentId}}">
        <paper-icon-button id="star" icon="icons:star" on-click="_onStarClicked"></paper-icon-button>
      </template>
    </paper-item>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'ptm-bookmark',
    properties: {
      url: {
        type: String,
        value: '',
        reflectToAttribute: true
      },
      favIconUrl: {
        type: String,
        value: '',
        reflectToAttribute: true
      },
      parentId: {
        type: String,
        value: '',
        reflectToAttribute: true
      },
      tabId: {
        type: String,
        value: '',
        reflectToAttribute: true,
        observer: '_computeActive'
      },
      bookmarkId: {
        type: String,
        value: '',
        reflectToAttribute: true,
        observer: '_computeBookmark'
      },
      title: {
        type: String,
        value: '',
        reflectToAttribute: true
      }
    },
    open: function() {
      var that = this;
      // If tab id is not assigned
      if (!this.tabId) {
        // Open new project entry
        chrome.tabs.create({url: this.url, active: true});
      } else {
        chrome.tabs.get(this.tabId, function(tab) {
          // If the project filed is not open yet
          if (!tab) {
            // Open new project entry
            chrome.tabs.create({url: that.url, active: true});
          // If the project filed is already open
          } else {
            chrome.windows.get(tab.windowId, function(win) {
              if (!win.focused) {
                // Move focus to the window
                chrome.windows.update(tab.windowId, {focused:true});
              }
              // Activate open project entry
              chrome.tabs.update(that.tabId, {active: true});
            });
          }
        });
      }
    },
    _computeActive: function() {
      this.toggleClass('active', !!this.tabId, this.$.title);
    },
    _computeBookmark: function() {
      this.toggleClass('bookmarked', !!this.bookmarkId, this.$.star);
    },
    _onStarClicked: function(e) {
      this.fire('toggle-bookmark', {
        bookmarkId: this.bookmarkId,
        tabId: this.tabId
      });
    }
  })
</script>
