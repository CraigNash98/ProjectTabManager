<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-pages/core-pages.html">
<link rel="import" href="../bower_components/core-item/core-item.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../bower_components/core-menu/core-menu.html">
<link rel="import" href="../bower_components/core-menu/core-submenu.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<polymer-element name="ptm-app">
  <template>
    <link rel="stylesheet" href="../css/ptm-app.css">
    <core-drawer-panel id="drawerPanel">
      <core-header-panel drawer>
        <core-toolbar>Project Tab Manager</core-toolbar>
        <paper-item>
          <core-icon icon="tab"></core-icon>Sessions
        </paper-item>
        <paper-item>
          <core-icon icon="star"></core-icon>Projects
        </paper-item>
        <paper-item>
          <core-icon icon="history"></core-icon>History
        </paper-item>
        <paper-item on-click="{{openOptions}}">
          <core-icon icon="settings"></core-icon>Settings
        </paper-item>
      </core-header-panel>
      <core-header-panel main>
        <core-toolbar>
          <core-icon-button icon="menu" on-click="{{toggle}}"></core-icon-button>
          <paper-input label="Search" value="{{query}}" flex></paper-input>
          <core-icon-button icon="refresh" on-click="{{reload}}"></core-icon-button>
        </core-toolbar>
        <core-pages id="main" selected="{{selectedMenu}}">
          <ptm-project-list projects="{{projects}}" query="{{query}}"></ptm-project-list>
        </core-pages>
        <paper-fab icon="add"></paper-fab>
      </core-header-panel>
    </core-drawer-panel>

    <script>
      var ProjectManager = chrome.extension.getBackgroundPage().projectManager;
      var Background = {
        // Create folder and add all tabs in specified window there
        createProject: function(title) {
          return new Promise(function(resolve) {
            chrome.runtime.sendMessage({
              command: 'createProject',
              title: title
            }, resolve);
          });
        },
        // Rename specified project folder
        renameProject: function(projectId, newTitle) {
          return new Promise(function(resolve) {

          });
        }
      };

      Polymer('ptm-app', {
        activeProjectId: 0,
        selectedMenu: 0,
        activeProject: null,
        created: function() {
          this.projects = [];
        },
        setActiveProjectId: function(id) {
          this.activeProjectId = id;
        },
        ready: function() {
          // this.activeProject = ProjectManager.getActiveProject();
          // this.setActiveProjectId(activeProject && activeProject.id || '0');
          var that = this;
          // TODO: trigger this from background
          chrome.runtime.onMessage.addListener(function(msg, sender) {
            console.log('received', msg);
            if (msg.command == 'app-ready') {
              that.projects = ProjectManager.projects;
            }
          });
        }
      });
    </script>
  </template>
</polymer-element>

<polymer-element name="ptm-project-list">
  <template>
    <style>
      core-menu {
        margin: 0;
        padding: 0 10px;
      }
    </style>
    <core-menu>
      <template repeat="{{project, i in projects}}">
        <ptm-project label="{{project.title}}" entry="{{project}}" on-rename-project="{{renameProject}}" on-remove-project="{{removeProject}}"></ptm-project>
      </template>
    </core-menu>
  </template>
  <script>
    var ProjectManager = chrome.extension.getBackgroundPage().projectManager;

    Polymer('ptm-project-list', {
      publish: {
        projects: {
          value: [],
          reflect: false
        }
      },
      created: function() {
        this.projects = ProjectManager.projects;
      },
      renameProject: function(e, detail, sender) {
        // TODO: implement
        // chrome.runtime.sendMessage({
        //   command: 'renameProject',
        //   projectId: sender.entry.id,
        //   title: detail.newTitle
        // });
      },
      removeProject: function(e, detail, sender) {
        chrome.runtime.sendMessage({
          command: 'removeProject',
          projectId: sender.entry.id
        });
      },
      reload: function() {
        chrome.runtime.sendMessage({
          command: 'update',
          // forceReload: force_reload
          forceReload: true
        }, function() {
console.log('reloaded');
          this.projects = ProjectManager.projects;
        });
      },
      set_dialog_title: function(title) {
        // $scope.dialog_title = title;
      },
      ready: function() {
        var that = this;
        chrome.runtime.onMessage.addListener(function(msg, sender) {
          console.log('ptm-project-list event received:', msg);
          if (msg.command == 'app-ready') {
            that.projects = ProjectManager.projects;
          }
        })
      }
    });
  </script>
</polymer-element>

<polymer-element name="ptm-project" attributes="entry expanded">
  <template>
    <style>
      header {
        box-sizing: border-box;
        height: 24px;
        margin: 0px;
        padding: 0px;
      }
      core-icon-button {
        width: 24px;
        height: 24px;
        padding: 2px;
        margin: 0px;
      }
      core-item {
        min-height: 0;
        height: 20px;
        padding: 2px;
        margin: 0;
        cursor: pointer;
      }
      :host /deep/ #label {
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        font-size: 1.2em;
      }
      core-icon-button::shadow core-icon {
        width: 20px;
        height: 20px;
      }
    </style>
    <header layout horizontal on-click="{{clicked}}">
      <core-icon-button icon="{{$.collapse.opened ? 'unfold-more' : 'unfold-less'}}" on-click="{{toggle}}"></core-icon-button>
      <core-item class="name" label="{{entry.title}}" flex></core-item>
      <core-icon-button icon="create" on-click="{{clickEdit}}"></core-icon-button>
      <core-icon-button icon="delete" on-click="{{clickRemove}}"></core-icon-button>
      <paper-ripple fit></paper-ripple>
    </header>
    <div id="submenu">
      <template repeat="{{field in entry.fields}}">
        <ptm-bookmark entry="{{field}}" on-toggle-bookmark="{{toggleBookmark}}"></ptm-bookmark>
      </template>
    </div>
    <core-collapse target="{{$.submenu}}" opened="{{expanded}}" id="collapse"></core-collapse>
  </template>
  <script>
    Polymer('ptm-project', {
      expanded: false,
      created: function() {
        this.entry = {};
      },
      clicked: function(e, detail, sender) {
        console.log(e, sender);
      },
      toggle: function(e, detail, sender) {
        e.stopPropagation();
        this.$.collapse.toggle();
      },
      clickCreate: function() {
        // TODO: implement rename function
        // this.fire('rename-project', {newTitle: this.entry.title});
      },
      clickDelete: function() {
        this.fire('remove-project');
      },
      toggleBookmark: function(e, detail, sender) {
        e.stopPropagation();
        console.log('toggle-bookmark', e, detail, sender);
        if (sender.entry.id) {
          this.entry.removeBookmark(sender.entry.id, function() {
            sender.entry.id = undefined;
          });
        } else {
          this.entry.addBookmark(sender.entry.tabId, function(bookmark) {
            sender.entry.id = bookmark.id;
          });
        }
      }
    });
  </script>
</polymer-element>

<polymer-element name="ptm-bookmark" attributes="entry">
  <template>
    <style>
      core-icon-button {
        width: 24px;
        height: 24px;
        padding: 2px;
        margin: 0px;
      }
      core-item {
        min-height: 0;
        height: 20px;
        padding: 2px;
        margin: 0;
        cursor: pointer;
      }
      :host /deep/ #label {
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        font-size: 1.2em;
      }
      core-icon-button::shadow core-icon {
        width: 20px;
        height: 20px;
      }
    </style>
    <div layout horizontal>
      <core-icon-button src="{{entry.favIconUrl}}"></core-icon-button>
      <core-item title="{{entry.title}}
  {{entry.url}}" label="{{entry.title}}" on-click="{{open}}" flex>
      </core-item>
      <core-icon-button icon="{{entry.id ? 'star' : 'star-outline'}}" active="{{bookmarked}}" on-click="{{starClick}}"></core-icon-button>
  </div>
  </template>
  <script charset="utf-8">
    Polymer('ptm-bookmark', {
      open: function() {
        var tabId = this.entry.tabId;
        // If tab id is not assigned
        if (!tabId) {
          // Open new project entry
          chrome.tabs.create({url: this.entry.url, active: true});
        } else {
          chrome.tabs.get(tabId, function(tab) {
            // If the project filed is not open yet
            if (!tab) {
              // Open new project entry
              chrome.tabs.create({url: this.entry.url, active: true});
            // If the project filed is already open
            } else {
              chrome.windows.get(tab.windowId, function(win) {
                if (!win.focused) {
                  // Move focus to the window
                  chrome.windows.update(tab.windowId, {focused:true});
                }
                // Activate open project entry
                chrome.tabs.update(tabId, {active: true});
              });
            }
          });
        }
      },
      starClick: function(e) {
        this.fire('toggle-bookmark');
      }
    })
  </script>
</polymer-elements>
